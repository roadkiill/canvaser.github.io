<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvaser - by Roadkiill</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a; color: #fff; overflow: hidden; height: 100vh;
        }
        .app-container { display: flex; height: 100vh; }

        /* â”€â”€ Sidebar â”€â”€ */
        .sidebar {
            width: 256px; background: #111; border-right: 1px solid #222;
            display: flex; flex-direction: column; padding: 16px;
            overflow-y: auto; flex-shrink: 0;
        }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        .logo { font-size: 17px; font-weight: 700; margin-bottom: 20px; }
        .section { margin-bottom: 18px; }
        .section-title { font-size: 10px; font-weight: 600; color: #555; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 10px; }

        /* Tools */
        .tools { display: flex; flex-wrap: wrap; gap: 6px; }
        .tool-btn {
            width: 38px; height: 38px; background: #1a1a1a; border: 1px solid #2a2a2a;
            border-radius: 6px; cursor: pointer; display: flex; align-items: center;
            justify-content: center; transition: all 0.15s; color: #ccc;
        }
        .tool-btn:hover { background: #252525; border-color: #3a3a3a; color: #fff; }
        .tool-btn.active { background: #2563eb; border-color: #2563eb; color: #fff; }

        /* Sliders */
        .slider-group { margin-bottom: 12px; }
        .slider-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 6px; color: #aaa; }
        .slider { width: 100%; height: 4px; background: #2a2a2a; border-radius: 2px; outline: none; -webkit-appearance: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 13px; height: 13px; background: #fff; border-radius: 50%; cursor: pointer; }
        .slider::-moz-range-thumb { width: 13px; height: 13px; background: #fff; border-radius: 50%; cursor: pointer; border: none; }

        /* Text panel */
        .text-options { display: none; }
        .text-options.visible { display: block; }
        .text-row { display: flex; gap: 6px; margin-bottom: 8px; align-items: center; }
        .text-select {
            flex: 1; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 5px;
            color: #fff; font-size: 12px; padding: 5px 7px; outline: none;
        }
        .text-toggle {
            width: 32px; height: 28px; background: #1a1a1a; border: 1px solid #2a2a2a;
            border-radius: 5px; color: #ccc; cursor: pointer; font-size: 12px;
            display: flex; align-items: center; justify-content: center; transition: all 0.15s;
        }
        .text-toggle:hover { background: #252525; }
        .text-toggle.on { background: #2563eb; border-color: #2563eb; color: #fff; }
        .text-preview {
            padding: 6px 8px; background: #1a1a1a; border: 1px solid #2a2a2a;
            border-radius: 5px; font-size: 13px; color: #ccc; min-height: 28px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* Colors */
        .color-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; margin-bottom: 8px; }
        .color-swatch { width: 100%; aspect-ratio: 1; border-radius: 5px; cursor: pointer; border: 2px solid transparent; transition: transform 0.15s; }
        .color-swatch:hover { transform: scale(1.12); }
        .color-swatch.active { border-color: #fff; box-shadow: 0 0 0 2px #111; }
        .custom-row { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
        .custom-row label { font-size: 11px; color: #666; }
        input[type="color"] { width: 32px; height: 24px; border: 1px solid #2a2a2a; border-radius: 4px; background: #1a1a1a; cursor: pointer; padding: 1px; }

        /* Boards */
        .boards-list { display: flex; flex-direction: column; gap: 5px; }
        .board-item { padding: 9px 11px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.15s; display: flex; justify-content: space-between; align-items: center; }
        .board-item:hover { background: #252525; border-color: #3a3a3a; }
        .board-item.active { background: #2563eb; border-color: #2563eb; }
        .board-count { font-size: 10px; color: #888; }
        .board-item.active .board-count { color: #bfdbfe; }

        /* Actions */
        .action-btn { width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 6px; color: #fff; font-size: 12px; cursor: pointer; transition: all 0.15s; margin-bottom: 6px; font-weight: 500; }
        .action-btn:hover { background: #252525; border-color: #3a3a3a; }
        .action-btn.danger:hover { background: #dc2626; border-color: #dc2626; }
        .action-btn.logout { background: #7f1d1d; border-color: #991b1b; }
        .action-btn.logout:hover { background: #991b1b; }

        /* Status */
        .status { margin-top: auto; padding-top: 14px; border-top: 1px solid #1e1e1e; }
        .status-item { display: flex; justify-content: space-between; font-size: 11px; color: #555; margin-bottom: 5px; }
        .status-value { color: #fff; font-weight: 600; }
        .online-indicator { display: flex; align-items: center; gap: 6px; font-size: 11px; color: #555; margin-bottom: 8px; }
        .online-dot { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

        /* Canvas area */
        .canvas-area {
            flex: 1; position: relative; overflow: hidden;
            background: #181818;
            background-image: radial-gradient(circle, #262626 1px, transparent 1px);
            background-size: 22px 22px;
        }
        #canvasWrapper { position: absolute; top: 50%; left: 50%; transform-origin: 0 0; }
        #drawingCanvas { display: block; background: #fff; box-shadow: 0 4px 40px rgba(0,0,0,0.7); }
        #lassoCanvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        #textInputOverlay { position: absolute; display: none; z-index: 50; }
        #textInputBox {
            background: transparent; border: 1.5px dashed #3b82f6;
            outline: none; color: inherit; font-family: inherit;
            min-width: 80px; padding: 2px 4px; caret-color: #3b82f6;
            resize: none; overflow: hidden; white-space: pre;
        }

        /* Cursors */
        .canvas-area.brush-cursor   #drawingCanvas { cursor: crosshair; }
        .canvas-area.eraser-cursor  #drawingCanvas { cursor: cell; }
        .canvas-area.text-cursor    #drawingCanvas { cursor: text; }
        .canvas-area.lasso-cursor   #drawingCanvas { cursor: crosshair; }
        .canvas-area.fill-cursor    #drawingCanvas { cursor: crosshair; }
        .canvas-area.panning        #drawingCanvas { cursor: grabbing !important; }

        /* Live cursors */
        #cursorOverlay { position: absolute; inset: 0; pointer-events: none; }
        .live-cursor { position: absolute; pointer-events: none; }
        .live-cursor-label { position: absolute; top: 18px; left: 8px; font-size: 11px; font-weight: 700; white-space: nowrap; padding: 2px 6px; border-radius: 4px; color: #fff; }

        /* Loading */
        .loading-overlay { position: fixed; inset: 0; background: #0a0a0a; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 16px; z-index: 1000; }
        .spinner { width: 36px; height: 36px; border: 3px solid #222; border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: #555; font-size: 13px; }

        /* Auth modal */
        .auth-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .auth-box { background: #111; border: 1px solid #333; border-radius: 12px; padding: 32px; width: 90%; max-width: 400px; }
        .auth-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; text-align: center; }
        .auth-subtitle { font-size: 13px; color: #888; text-align: center; margin-bottom: 24px; }
        .auth-tabs { display: flex; gap: 8px; margin-bottom: 24px; }
        .auth-tab { flex: 1; padding: 10px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 6px; cursor: pointer; text-align: center; font-size: 13px; font-weight: 600; transition: all 0.15s; }
        .auth-tab:hover { background: #252525; }
        .auth-tab.active { background: #2563eb; border-color: #2563eb; }
        .auth-form { display: flex; flex-direction: column; gap: 14px; }
        .auth-input { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 6px; padding: 12px 14px; color: #fff; font-size: 14px; outline: none; font-family: inherit; }
        .auth-input:focus { border-color: #2563eb; }
        .auth-input::placeholder { color: #555; }
        .auth-submit { background: #2563eb; border: none; border-radius: 6px; padding: 12px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.15s; }
        .auth-submit:hover { background: #1d4ed8; }
        .auth-submit:disabled { opacity: 0.5; cursor: not-allowed; }
        .auth-error { background: #7f1d1d; border: 1px solid #991b1b; border-radius: 6px; padding: 10px 12px; font-size: 12px; color: #fca5a5; margin-bottom: 14px; }
        .auth-hint { font-size: 11px; color: #666; margin-top: -8px; }

        /* Vote */
        .vote-banner { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #1a1a1a; border: 2px solid #ef4444; border-radius: 8px; padding: 16px 20px; z-index: 500; min-width: 340px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from{opacity:0;transform:translateX(-50%) translateY(-14px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }
        .vote-header { font-weight: 700; margin-bottom: 6px; color: #ef4444; font-size: 14px; }
        .vote-reason { font-size: 12px; color: #aaa; margin-bottom: 12px; }
        .vote-actions { display: flex; gap: 8px; }
        .vote-btn { flex:1; padding:8px; border:none; border-radius:4px; cursor:pointer; font-size:12px; font-weight:600; transition:all 0.15s; }
        .vote-yes { background:#ef4444; color:#fff; } .vote-yes:hover { background:#dc2626; }
        .vote-no  { background:#2a2a2a; color:#fff; } .vote-no:hover  { background:#3a3a3a; }
        .vote-status { margin-top:8px; font-size:11px; color:#666; }

        /* Chat */
        .chat-container { position: fixed; bottom: 20px; right: 20px; width: 300px; background: #111; border: 1px solid #222; border-radius: 8px; display: none; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 100; }
        .chat-header { padding: 10px 14px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .chat-title { font-size: 13px; font-weight: 600; }
        .chat-toggle { background:none; border:none; color:#666; cursor:pointer; font-size:16px; }
        .chat-toggle:hover { color:#fff; }
        .chat-messages { height: 250px; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 5px; }
        .chat-messages::-webkit-scrollbar { width: 4px; }
        .chat-messages::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        .chat-message { font-size: 12px; line-height: 1.4; word-break: break-word; }
        .chat-username { font-weight: 700; margin-right: 3px; }
        .chat-text { color: #bbb; }
        .chat-system { color: #555; font-style: italic; font-size: 11px; }
        .chat-input-wrap { padding: 10px; border-top: 1px solid #222; }
        .chat-input { width: 100%; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 5px; padding: 8px 10px; color: #fff; font-size: 12px; outline: none; font-family: inherit; }
        .chat-input:focus { border-color: #3a3a3a; }
        .chat-input::placeholder { color: #555; }
        .chat-container.minimized .chat-messages,
        .chat-container.minimized .chat-input-wrap { display: none; }

        /* Zoom pill */
        .zoom-pill { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: rgba(17,17,17,0.9); border: 1px solid #333; border-radius: 20px; padding: 5px 14px; font-size: 12px; color: #aaa; pointer-events: none; opacity: 0; transition: opacity 0.3s; }
        .zoom-pill.visible { opacity: 1; }

        /* Konami */
        .konami-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.97); z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        .konami-title { font-size: 44px; font-weight: 800; margin-bottom: 14px; background: linear-gradient(45deg,#ff0080,#ff8c00,#40e0d0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: rainbow 3s linear infinite; }
        @keyframes rainbow { 0%{filter:hue-rotate(0deg)} 100%{filter:hue-rotate(360deg)} }
        .konami-sub { font-size: 15px; color: #888; margin-bottom: 22px; }
        .konami-close { padding: 10px 22px; background: #2563eb; border: none; border-radius: 6px; color: #fff; font-size: 13px; cursor: pointer; font-weight: 600; }
        .konami-close:hover { background: #1d4ed8; }
    </style>
</head>
<body>

<div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div class="loading-text">Connectingâ€¦</div>
</div>

<!-- Auth Modal -->
<div class="auth-modal" id="authModal" style="display:none">
    <div class="auth-box">
        <div class="auth-title">Welcome to Canvaser</div>
        <div class="auth-subtitle">Sign in or create an account to start drawing</div>
        
        <div class="auth-tabs">
            <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
            <div class="auth-tab" onclick="switchAuthTab('register')">Register</div>
        </div>

        <div id="authError" class="auth-error" style="display:none"></div>

        <!-- Login Form -->
        <form class="auth-form" id="loginForm">
            <input type="email" class="auth-input" id="loginEmail" placeholder="Email" required autocomplete="email">
            <input type="password" class="auth-input" id="loginPassword" placeholder="Password" required autocomplete="current-password">
            <button type="submit" class="auth-submit">Login</button>
        </form>

        <!-- Register Form -->
        <form class="auth-form" id="registerForm" style="display:none">
            <input type="text" class="auth-input" id="regUsername" placeholder="Username" required minlength="3" maxlength="20" autocomplete="off">
            <div class="auth-hint">3-20 characters, letters and numbers only</div>
            <input type="email" class="auth-input" id="regEmail" placeholder="Email" required autocomplete="email">
            <input type="password" class="auth-input" id="regPassword" placeholder="Password" required minlength="6" autocomplete="new-password">
            <div class="auth-hint">Minimum 6 characters</div>
            <button type="submit" class="auth-submit">Create Account</button>
        </form>
    </div>
</div>

<div class="app-container" id="app" style="display:none">

    <div class="sidebar">
        <div class="logo">Canvaser - by Roadkiill</div>

        <div class="section">
            <div class="section-title">Tools</div>
            <div class="tools">
                <div class="tool-btn active" id="brushTool"     onclick="selectTool('brush')"     title="Brush (B)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/></svg>
                </div>
                <div class="tool-btn" id="eraserTool"    onclick="selectTool('eraser')"    title="Eraser (E)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 20H7L3 16L11 8L17 14L20 11V20Z"/><path d="M3 16L11 8L17 14"/></svg>
                </div>
                <div class="tool-btn" id="fillTool"      onclick="selectTool('fill')"      title="Fill bucket (F)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 9l-6-6-6 6v12h12V9z"/><circle cx="18" cy="20" r="2"/></svg>
                </div>
                <div class="tool-btn" id="lassoTool"     onclick="selectTool('lasso')"     title="Lasso fill (L)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3C7 3 3 6.5 3 10.5c0 2.5 1.5 4.5 4 5.5L6 20h12l-1-4c2.5-1 4-3 4-5.5C21 6.5 17 3 12 3z"/></svg>
                </div>
                <div class="tool-btn" id="textTool"      onclick="selectTool('text')"      title="Text (T)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
                </div>
                <div class="tool-btn" id="lineTool"      onclick="selectTool('line')"      title="Line">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="20" x2="20" y2="4"/></svg>
                </div>
                <div class="tool-btn" id="circleTool"    onclick="selectTool('circle')"    title="Circle">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="8"/></svg>
                </div>
                <div class="tool-btn" id="rectangleTool" onclick="selectTool('rectangle')" title="Rectangle">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="7" width="14" height="10"/></svg>
                </div>
                <div class="tool-btn" id="sprayTool"     onclick="selectTool('spray')"     title="Spray">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="6" cy="6" r="1" fill="currentColor"/><circle cx="10" cy="8" r="1" fill="currentColor"/><circle cx="8" cy="11" r="1" fill="currentColor"/><circle cx="12" cy="13" r="1" fill="currentColor"/><circle cx="15" cy="9" r="1" fill="currentColor"/><path d="M18 3l3 3-12 12-3-3z"/></svg>
                </div>
                <div class="tool-btn" id="reportTool"    onclick="selectTool('report')"    title="Report stroke" style="border-color:#7f1d1d">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                </div>
                <div class="tool-btn" onclick="undo()" title="Undo (Ctrl+Z)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>
                </div>
                <div class="tool-btn" onclick="redo()" title="Redo (Ctrl+Y)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"/></svg>
                </div>
            </div>
        </div>

        <!-- Brush options -->
        <div class="section" id="brushSection">
            <div class="section-title">Brush</div>
            <div class="slider-group">
                <div class="slider-label"><span>Size</span><span id="brushSizeValue">5</span></div>
                <input type="range" class="slider" id="brushSize" min="1" max="50" value="5">
            </div>
            <div class="slider-group">
                <div class="slider-label"><span>Opacity</span><span id="opacityValue">100</span></div>
                <input type="range" class="slider" id="opacity" min="1" max="100" value="100">
            </div>
        </div>

        <!-- Text options -->
        <div class="section text-options" id="textSection">
            <div class="section-title">Text</div>
            <div class="slider-group">
                <div class="slider-label"><span>Font size</span><span id="fontSizeValue">24</span></div>
                <input type="range" class="slider" id="fontSize" min="8" max="120" value="24">
            </div>
            <div class="text-row">
                <select class="text-select" id="fontFamily">
                    <option value="sans-serif">Sans-serif</option>
                    <option value="serif">Serif</option>
                    <option value="monospace">Monospace</option>
                    <option value="cursive">Cursive</option>
                    <option value="Georgia, serif">Georgia</option>
                    <option value="'Comic Sans MS', cursive">Comic Sans</option>
                    <option value="Impact, sans-serif">Impact</option>
                    <option value="'Courier New', monospace">Courier New</option>
                </select>
            </div>
            <div class="text-row">
                <button class="text-toggle" id="boldToggle"      onclick="toggleTStyle('bold')"      title="Bold"><b>B</b></button>
                <button class="text-toggle" id="italicToggle"    onclick="toggleTStyle('italic')"    title="Italic"><i>I</i></button>
                <button class="text-toggle" id="underlineToggle" onclick="toggleTStyle('underline')" title="Underline"><u>U</u></button>
            </div>
            <div class="text-preview" id="textPreview">Aa â€” click canvas to type</div>
        </div>

        <div class="section">
            <div class="section-title">Colors</div>
            <div class="color-grid" id="colorGrid"></div>
            <div class="custom-row">
                <label>Custom</label>
                <input type="color" id="customColor" value="#000000" title="Pick any color">
            </div>
        </div>

        <div class="section">
            <div class="section-title">Boards</div>
            <div class="boards-list" id="boardsList"></div>
        </div>

        <div class="section">
            <div class="section-title">Actions</div>
            <button class="action-btn" onclick="downloadCanvas()">Download Canvas</button>
            <button class="action-btn danger" onclick="clearCanvas()">Clear All</button>
            <button class="action-btn logout" onclick="logout()">Logout</button>
        </div>

        <div class="status">
            <div class="online-indicator">
                <div class="online-dot"></div>
                <span id="onlineCount">0 online</span>
            </div>
            <div class="status-item">
                <span>You</span>
                <span class="status-value" id="myUsername" style="font-size:11px"></span>
            </div>
            <div class="status-item">
                <span>Strokes</span>
                <span class="status-value" id="strokeCount">0</span>
            </div>
        </div>
    </div>

    <!-- Canvas area -->
    <div class="canvas-area brush-cursor" id="canvasArea">
        <div id="canvasWrapper">
            <canvas id="drawingCanvas" width="1400" height="900"></canvas>
            <canvas id="lassoCanvas"   width="1400" height="900"></canvas>
            <div id="textInputOverlay">
                <textarea id="textInputBox" rows="1" placeholder="Typeâ€¦ Enter to place, Esc to cancel"></textarea>
            </div>
        </div>
        <div id="cursorOverlay"></div>
    </div>
</div>

<!-- Chat -->
<div class="chat-container" id="chatContainer">
    <div class="chat-header" onclick="toggleChat()">
        <div class="chat-title">ðŸ’¬ Chat</div>
        <button class="chat-toggle" id="chatToggleBtn">âˆ’</button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-wrap">
        <input type="text" class="chat-input" id="chatInput"
            placeholder="Messageâ€¦ (Enter to send)" maxlength="200"
            onkeydown="if(event.key==='Enter')sendMsg()">
    </div>
</div>

<div class="zoom-pill" id="zoomPill">100%</div>

<script type="module">
import { initializeApp }  from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, push, onChildAdded,
         remove, set, onValue, onDisconnect, get, update }
                          from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
         onAuthStateChanged, signOut }
                          from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Firebase config
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const app = initializeApp({
    apiKey:            "AIzaSyBU-dUURuUm0DrCVYR-W-IaF6Qr_SiA5ac",
    authDomain:        "draw-app-4f585.firebaseapp.com",
    databaseURL:       "https://draw-app-4f585-default-rtdb.firebaseio.com",
    projectId:         "draw-app-4f585",
    storageBucket:     "draw-app-4f585.firebasestorage.app",
    messagingSenderId: "148544401774",
    appId:             "1:148544401774:web:33d711f85dc17361b1d17f"
});
const db = getDatabase(app);
const auth = getAuth(app);

// â”€â”€ Global state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let userId = null;
let username = null;
const U_COLORS = ['#EF4444','#F59E0B','#10B981','#3B82F6','#8B5CF6','#EC4899','#06B6D4','#6366F1','#A855F7','#F43F5E','#14B8A6','#F97316','#84CC16','#0EA5E9','#D946EF'];
let userColor = U_COLORS[Math.floor(Math.random()*U_COLORS.length)];

// â”€â”€ Canvas refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas    = document.getElementById('drawingCanvas');
const ctx       = canvas.getContext('2d');
const lassoC    = document.getElementById('lassoCanvas');
const lassoCtx  = lassoC.getContext('2d');
const wrapper   = document.getElementById('canvasWrapper');
const canvasArea = document.getElementById('canvasArea');

// â”€â”€ App state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentBoard = 'board1';
let strokesRef   = ref(db, `boards/${currentBoard}/strokes`);
const chatRef    = ref(db, 'chat');

let isDrawing    = false;
let currentStroke = [];
let currentTool  = 'brush';
let currentColor = '#000000';
let brushSize    = 5;
let opacity      = 100;
let allStrokes   = {};
let undoStack    = [];
let redoStack    = [];
let shapeStart   = null;
let lastShapeEnd = null;
let lassoPoints  = [];
let strokeCount  = 0;

// Text
let tBold = false, tItalic = false, tUnderline = false;
let tSize = 24, tFont = 'sans-serif';
let pendingTextPos = null;

// Zoom/pan
let scale = 1, panX = 0, panY = 0;
let isPanning = false, panStart = {x:0,y:0};

// â”€â”€ Auth helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAuthError(msg) {
    const el = document.getElementById('authError');
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 5000);
}

window.switchAuthTab = function(tab) {
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const tabs = document.querySelectorAll('.auth-tab');
    
    tabs.forEach(t => t.classList.remove('active'));
    if (tab === 'login') {
        tabs[0].classList.add('active');
        loginForm.style.display = 'flex';
        registerForm.style.display = 'none';
    } else {
        tabs[1].classList.add('active');
        loginForm.style.display = 'none';
        registerForm.style.display = 'flex';
    }
    document.getElementById('authError').style.display = 'none';
};

// Login form
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    try {
        const submitBtn = e.target.querySelector('.auth-submit');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Logging in...';
        
        await signInWithEmailAndPassword(auth, email, password);
        // Auth state change will handle the rest
    } catch (error) {
        console.error('Login error:', error);
        let msg = 'Login failed. Please check your credentials.';
        if (error.code === 'auth/user-not-found') msg = 'No account found with this email.';
        if (error.code === 'auth/wrong-password') msg = 'Incorrect password.';
        if (error.code === 'auth/invalid-email') msg = 'Invalid email address.';
        showAuthError(msg);
        
        const submitBtn = e.target.querySelector('.auth-submit');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Login';
    }
});

// Register form
document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const uname = document.getElementById('regUsername').value.trim();
    const email = document.getElementById('regEmail').value;
    const password = document.getElementById('regPassword').value;
    
    // Validate username
    if (!/^[a-zA-Z0-9]{3,20}$/.test(uname)) {
        showAuthError('Username must be 3-20 characters (letters and numbers only)');
        return;
    }
    
    try {
        const submitBtn = e.target.querySelector('.auth-submit');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating account...';
        
        // Check if username is taken
        const usernamesSnap = await get(ref(db, 'usernames'));
        const usernames = usernamesSnap.val() || {};
        if (Object.values(usernames).includes(uname.toLowerCase())) {
            showAuthError('Username already taken. Please choose another.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Account';
            return;
        }
        
        // Create user
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const uid = userCredential.user.uid;
        
        // Store username
        await set(ref(db, `usernames/${uid}`), uname.toLowerCase());
        await set(ref(db, `userProfiles/${uid}`), {
            username: uname,
            color: userColor,
            created: Date.now()
        });
        
        // Auth state change will handle the rest
    } catch (error) {
        console.error('Registration error:', error);
        let msg = 'Registration failed. Please try again.';
        if (error.code === 'auth/email-already-in-use') msg = 'Email already registered. Please login instead.';
        if (error.code === 'auth/invalid-email') msg = 'Invalid email address.';
        if (error.code === 'auth/weak-password') msg = 'Password too weak. Use at least 6 characters.';
        showAuthError(msg);
        
        const submitBtn = e.target.querySelector('.auth-submit');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Account';
    }
});

window.logout = async function() {
    if (!confirm('Are you sure you want to logout?')) return;
    try {
        await signOut(auth);
        location.reload();
    } catch (error) {
        console.error('Logout error:', error);
        alert('Failed to logout. Please try again.');
    }
};

// Auth state observer
onAuthStateChanged(auth, async (user) => {
    if (user) {
        userId = user.uid;
        
        // Load user profile
        const profileSnap = await get(ref(db, `userProfiles/${userId}`));
        if (profileSnap.exists()) {
            const profile = profileSnap.val();
            username = profile.username;
            userColor = profile.color || userColor;
        } else {
            // Try to get display name from Gmail account
            if (user.displayName) {
                username = user.displayName.split(' ')[0]; // Get first name
            } else if (user.email) {
                // Extract name from email (before @)
                username = user.email.split('@')[0];
            } else {
                username = `user${userId.slice(0,4)}`;
            }
            
            // Save this as the user's profile
            await set(ref(db, `userProfiles/${userId}`), {
                username: username,
                color: userColor,
                created: Date.now()
            });
        }
        
        const myUsernameEl = document.getElementById('myUsername');
        myUsernameEl.textContent = username;
        myUsernameEl.style.color = userColor;
        
        // Hide auth modal, show app
        document.getElementById('authModal').style.display = 'none';
        document.getElementById('loading').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        document.getElementById('chatContainer').style.display = 'flex';
        
        // Initialize app
        await initApp();
    } else {
        // Show auth modal
        document.getElementById('loading').style.display = 'none';
        document.getElementById('authModal').style.display = 'flex';
        document.getElementById('app').style.display = 'none';
    }
});

// â”€â”€ Profanity filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BAD = ['fuck','shit','damn','ass','bitch','bastard','crap','piss','dick','cock','pussy','cunt','fag','nigger','nigga','whore','slut','retard','motherfucker','asshole','douche','twat'];
const censor = msg => BAD.reduce((s,w) => s.replace(new RegExp(w,'gi'),'*'.repeat(w.length)), msg);

// â”€â”€ Coordinates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPos(e) {
    const r = canvas.getBoundingClientRect();
    return { x:(e.clientX-r.left)/scale, y:(e.clientY-r.top)/scale };
}

// â”€â”€ Transform â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyTransform() {
    wrapper.style.transform = `translate(${panX - canvas.width*scale/2}px, ${panY - canvas.height*scale/2}px) scale(${scale})`;
    wrapper.style.transformOrigin = '0 0';
}

canvasArea.addEventListener('wheel', e => {
    e.preventDefault();
    const ns = Math.max(0.1, Math.min(8, scale * (e.deltaY>0 ? 0.9 : 1.1)));
    const ar = canvasArea.getBoundingClientRect();
    const mx = e.clientX - ar.left - ar.width/2;
    const my = e.clientY - ar.top  - ar.height/2;
    panX = mx - (mx-panX)*(ns/scale);
    panY = my - (my-panY)*(ns/scale);
    scale = ns;
    applyTransform();
    showZoom();
}, {passive:false});

canvasArea.addEventListener('mousedown', e => {
    if (e.button!==1) return;
    e.preventDefault();
    isPanning = true;
    panStart = {x:e.clientX-panX, y:e.clientY-panY};
    canvasArea.classList.add('panning');
});
document.addEventListener('mousemove', e => {
    if (!isPanning) return;
    panX = e.clientX-panStart.x;
    panY = e.clientY-panStart.y;
    applyTransform();
});
document.addEventListener('mouseup', e => {
    if (e.button===1) { isPanning=false; canvasArea.classList.remove('panning'); }
});

let _zt;
function showZoom() {
    const p = document.getElementById('zoomPill');
    p.textContent = Math.round(scale*100)+'%';
    p.classList.add('visible');
    clearTimeout(_zt); _zt = setTimeout(()=>p.classList.remove('visible'),1000);
}

// â”€â”€ Color palette â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PALETTE = ['#000000','#FFFFFF','#EF4444','#F59E0B','#10B981','#3B82F6','#8B5CF6','#EC4899','#64748B','#DC2626','#EA580C','#84CC16','#06B6D4','#6366F1','#A855F7','#F43F5E','#71717A','#78716C'];
function initColors() {
    const g = document.getElementById('colorGrid');
    PALETTE.forEach((c,i) => {
        const s = document.createElement('div');
        s.className = 'color-swatch'+(i===0?' active':'');
        s.style.background = c;
        s.onclick = () => setColor(c, s);
        g.appendChild(s);
    });
    document.getElementById('customColor').addEventListener('input', e => setColor(e.target.value, null));
}
function setColor(c, swatch) {
    currentColor = c;
    document.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('active'));
    if (swatch) swatch.classList.add('active');
    refreshTextPreview();
}

// â”€â”€ Tool selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.selectTool = function(tool) {
    if (currentTool==='text' && pendingTextPos) commitText();
    currentTool = tool;
    document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById(tool+'Tool')?.classList.add('active');
    canvasArea.className = 'canvas-area '+tool+'-cursor';
    document.getElementById('brushSection').style.display = (tool==='text') ? 'none' : 'block';
    document.getElementById('textSection').classList.toggle('visible', tool==='text');
    document.getElementById('textInputOverlay').style.display = 'none';
    pendingTextPos = null;
};

// â”€â”€ Text tool â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('fontSize').addEventListener('input', e => {
    tSize = parseInt(e.target.value);
    document.getElementById('fontSizeValue').textContent = tSize;
    refreshTextPreview();
});
document.getElementById('fontFamily').addEventListener('change', e => {
    tFont = e.target.value; refreshTextPreview();
});
window.toggleTStyle = function(s) {
    if (s==='bold')      { tBold=!tBold;       document.getElementById('boldToggle').classList.toggle('on',tBold); }
    if (s==='italic')    { tItalic=!tItalic;   document.getElementById('italicToggle').classList.toggle('on',tItalic); }
    if (s==='underline') { tUnderline=!tUnderline; document.getElementById('underlineToggle').classList.toggle('on',tUnderline); }
    refreshTextPreview();
};
function refreshTextPreview() {
    const el = document.getElementById('textPreview');
    el.style.fontFamily    = tFont;
    el.style.fontSize      = Math.min(tSize,18)+'px';
    el.style.fontWeight    = tBold      ? 'bold'      : 'normal';
    el.style.fontStyle     = tItalic    ? 'italic'    : 'normal';
    el.style.textDecoration= tUnderline ? 'underline' : 'none';
    el.style.color         = currentColor;
}
refreshTextPreview();

function buildFont() {
    return `${tItalic?'italic ':''}${tBold?'bold ':''}${tSize}px ${tFont}`;
}

function openTextInput(x, y) {
    const ov  = document.getElementById('textInputOverlay');
    const box = document.getElementById('textInputBox');
    pendingTextPos = {x,y};
    ov.style.display = 'block';
    ov.style.left    = x+'px';
    ov.style.top     = (y-tSize)+'px';
    box.style.font          = buildFont();
    box.style.color         = currentColor;
    box.style.fontWeight    = tBold      ? 'bold'      : 'normal';
    box.style.fontStyle     = tItalic    ? 'italic'    : 'normal';
    box.style.textDecoration= tUnderline ? 'underline' : 'none';
    box.style.fontSize      = tSize+'px';
    box.value = '';
    box.style.height = 'auto';
    setTimeout(()=>box.focus(), 10);
}

document.getElementById('textInputBox').addEventListener('keydown', e => {
    if (e.key==='Escape') {
        document.getElementById('textInputOverlay').style.display='none';
        pendingTextPos=null;
    }
    if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); commitText(); }
    setTimeout(() => {
        const b = document.getElementById('textInputBox');
        b.style.height='auto'; b.style.height=b.scrollHeight+'px';
    },0);
});

function commitText() {
    const box = document.getElementById('textInputBox');
    const txt = box.value.trim();
    document.getElementById('textInputOverlay').style.display='none';
    if (!txt || !pendingTextPos) { pendingTextPos=null; return; }
    const data = {
        type:'text', text:censor(txt),
        x:pendingTextPos.x, y:pendingTextPos.y,
        font:buildFont(), color:currentColor,
        underline:tUnderline, fontSize:tSize,
        userId, timestamp:Date.now()
    };
    push(strokesRef, data);
    undoStack.push(data); redoStack=[];
    pendingTextPos=null;
}

function drawText(d, ctx2) {
    ctx2.save();
    ctx2.font      = d.font;
    ctx2.fillStyle = d.color;
    ctx2.globalAlpha = 1;
    const fs = d.fontSize||24;
    const lines = d.text.split('\n');
    lines.forEach((line,i)=>{
        const ty = d.y + i*fs*1.3;
        ctx2.fillText(line, d.x, ty);
        if (d.underline) {
            const w = ctx2.measureText(line).width;
            ctx2.fillRect(d.x, ty+2, w, Math.max(1, fs*0.07));
        }
    });
    ctx2.restore();
}

// â”€â”€ Lasso fill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lassoAnimId;
function animateLasso() {
    if (currentTool!=='lasso'||!isDrawing) return;
    lassoCtx.clearRect(0,0,lassoC.width,lassoC.height);
    if (lassoPoints.length>1) {
        lassoCtx.save();
        lassoCtx.strokeStyle = currentColor;
        lassoCtx.lineWidth   = 1.5;
        const offset = (Date.now()/50)%9;
        lassoCtx.setLineDash([5,4]);
        lassoCtx.lineDashOffset = -offset;
        lassoCtx.beginPath();
        lassoCtx.moveTo(lassoPoints[0].x, lassoPoints[0].y);
        lassoPoints.forEach(p=>lassoCtx.lineTo(p.x,p.y));
        lassoCtx.closePath();
        lassoCtx.stroke();
        lassoCtx.restore();
    }
    lassoAnimId = requestAnimationFrame(animateLasso);
}
function commitLasso() {
    cancelAnimationFrame(lassoAnimId);
    lassoCtx.clearRect(0,0,lassoC.width,lassoC.height);
    if (lassoPoints.length<3) { lassoPoints=[]; return; }
    ctx.save();
    ctx.beginPath();
    ctx.moveTo(lassoPoints[0].x, lassoPoints[0].y);
    lassoPoints.forEach(p=>ctx.lineTo(p.x,p.y));
    ctx.closePath();
    const {r,g,b} = hexToRgb(currentColor);
    ctx.fillStyle = `rgba(${r},${g},${b},${opacity/100})`;
    ctx.fill();
    ctx.restore();
    const data = { type:'lasso', points:[...lassoPoints], color:currentColor, opacity, userId, timestamp:Date.now() };
    push(strokesRef, data);
    undoStack.push(data); redoStack=[];
    lassoPoints=[];
}
function drawLasso(d, ctx2) {
    if (!d.points||d.points.length<3) return;
    ctx2.save();
    ctx2.beginPath();
    ctx2.moveTo(d.points[0].x, d.points[0].y);
    d.points.forEach(p=>ctx2.lineTo(p.x,p.y));
    ctx2.closePath();
    const {r,g,b} = hexToRgb(d.color);
    ctx2.fillStyle = `rgba(${r},${g},${b},${d.opacity/100})`;
    ctx2.fill();
    ctx2.restore();
}

// â”€â”€ Drawing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startDrawing(e) {
    if (e.button!==0||isPanning) return;
    const pos = getPos(e);
    if (currentTool==='report') { handleReport(pos.x,pos.y); return; }
    if (currentTool==='fill')   { floodFill(pos.x,pos.y);    return; }
    if (currentTool==='text')   { openTextInput(pos.x,pos.y); return; }
    if (currentTool==='lasso')  {
        isDrawing=true; lassoPoints=[pos];
        cancelAnimationFrame(lassoAnimId); animateLasso(); return;
    }
    if (['line','circle','rectangle'].includes(currentTool)) {
        isDrawing=true; shapeStart=pos; return;
    }
    isDrawing=true; currentStroke=[pos];
}

const tmpC=document.createElement('canvas');
tmpC.width=canvas.width; tmpC.height=canvas.height;
const tmpCtx=tmpC.getContext('2d');

function draw(e) {
    if (!isDrawing||isPanning) return;
    const pos = getPos(e);
    if (currentTool==='lasso') { lassoPoints.push(pos); return; }
    if (['line','circle','rectangle'].includes(currentTool)) {
        lastShapeEnd=pos; previewShape(pos); return;
    }
    currentStroke.push(pos);
    if (currentTool==='spray') drawSpray(pos.x,pos.y,ctx);
    else drawStroke(currentStroke,currentColor,brushSize,opacity,currentTool,ctx);
}

function stopDrawing() {
    if (!isDrawing) return;
    isDrawing=false;
    cancelAnimationFrame(lassoAnimId);
    if (currentTool==='lasso') { commitLasso(); return; }
    if (['line','circle','rectangle'].includes(currentTool) && shapeStart) {
        const end=lastShapeEnd||shapeStart;
        const data={type:currentTool,start:shapeStart,end,color:currentColor,size:brushSize,opacity,userId,timestamp:Date.now()};
        shapeStart=null; lastShapeEnd=null;
        tmpCtx.clearRect(0,0,tmpC.width,tmpC.height);
        redrawCanvas();
        push(strokesRef,data); undoStack.push(data); redoStack=[];
        return;
    }
    if (currentStroke.length>0) {
        const data={points:currentStroke,color:currentColor,size:brushSize,opacity,tool:currentTool,userId,timestamp:Date.now()};
        push(strokesRef,data); undoStack.push(data); redoStack=[];
        currentStroke=[];
    }
}

function previewShape(end) {
    tmpCtx.clearRect(0,0,tmpC.width,tmpC.height);
    const {r,g,b}=hexToRgb(currentColor);
    tmpCtx.strokeStyle=`rgba(${r},${g},${b},${opacity/100})`;
    tmpCtx.lineWidth=brushSize; tmpCtx.lineCap='round';
    if (currentTool==='line') {
        tmpCtx.beginPath(); tmpCtx.moveTo(shapeStart.x,shapeStart.y); tmpCtx.lineTo(end.x,end.y); tmpCtx.stroke();
    } else if (currentTool==='circle') {
        const r2=Math.hypot(end.x-shapeStart.x,end.y-shapeStart.y);
        tmpCtx.beginPath(); tmpCtx.arc(shapeStart.x,shapeStart.y,r2,0,Math.PI*2); tmpCtx.stroke();
    } else {
        tmpCtx.strokeRect(shapeStart.x,shapeStart.y,end.x-shapeStart.x,end.y-shapeStart.y);
    }
    redrawCanvas(); ctx.drawImage(tmpC,0,0);
}

function drawStroke(pts,color,size,op,tool,ctx2) {
    if (pts.length<2) return;
    ctx2.save();
    ctx2.lineCap='round'; ctx2.lineJoin='round'; ctx2.lineWidth=size;
    if (tool==='eraser') {
        ctx2.globalCompositeOperation='destination-out';
        ctx2.strokeStyle='rgba(0,0,0,1)';
    } else {
        ctx2.globalCompositeOperation='source-over';
        const {r,g,b}=hexToRgb(color);
        ctx2.strokeStyle=`rgba(${r},${g},${b},${op/100})`;
    }
    ctx2.beginPath(); ctx2.moveTo(pts[0].x,pts[0].y);
    for (let i=1;i<pts.length;i++) ctx2.lineTo(pts[i].x,pts[i].y);
    ctx2.stroke(); ctx2.restore();
}

function drawShape(d,ctx2) {
    ctx2.save();
    ctx2.lineCap='round'; ctx2.lineWidth=d.size;
    const {r,g,b}=hexToRgb(d.color);
    ctx2.strokeStyle=`rgba(${r},${g},${b},${d.opacity/100})`;
    if (d.type==='line') {
        ctx2.beginPath(); ctx2.moveTo(d.start.x,d.start.y); ctx2.lineTo(d.end.x,d.end.y); ctx2.stroke();
    } else if (d.type==='circle') {
        const r2=Math.hypot(d.end.x-d.start.x,d.end.y-d.start.y);
        ctx2.beginPath(); ctx2.arc(d.start.x,d.start.y,r2,0,Math.PI*2); ctx2.stroke();
    } else {
        ctx2.strokeRect(d.start.x,d.start.y,d.end.x-d.start.x,d.end.y-d.start.y);
    }
    ctx2.restore();
}

function drawSpray(x,y,ctx2) {
    ctx2.save();
    ctx2.fillStyle=currentColor; ctx2.globalAlpha=opacity/100;
    for (let i=0;i<20;i++) {
        const a=Math.random()*Math.PI*2, d=Math.random()*brushSize*2;
        ctx2.fillRect(x+Math.cos(a)*d, y+Math.sin(a)*d, 1,1);
    }
    ctx2.restore();
}

function floodFill(sx,sy) {
    const img=ctx.getImageData(0,0,canvas.width,canvas.height), px=img.data;
    const p0=(Math.floor(sy)*canvas.width+Math.floor(sx))*4;
    const sR=px[p0],sG=px[p0+1],sB=px[p0+2];
    const {r:fR,g:fG,b:fB}=hexToRgb(currentColor);
    if (sR===fR&&sG===fG&&sB===fB) return;
    const stack=[{x:Math.floor(sx),y:Math.floor(sy)}], seen=new Set();
    while (stack.length) {
        const {x,y}=stack.pop(), key=`${x},${y}`;
        if (seen.has(key)||x<0||x>=canvas.width||y<0||y>=canvas.height) continue;
        const p=(y*canvas.width+x)*4;
        if (px[p]!==sR||px[p+1]!==sG||px[p+2]!==sB) continue;
        seen.add(key); px[p]=fR; px[p+1]=fG; px[p+2]=fB;
        stack.push({x:x+1,y},{x:x-1,y},{x,y:y+1},{x,y:y-1});
    }
    ctx.putImageData(img,0,0);
    push(strokesRef,{type:'fill',x:sx,y:sy,color:currentColor,userId,timestamp:Date.now()});
}

function redrawCanvas() {
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    Object.values(allStrokes)
        .sort((a,b)=>(a.timestamp||0)-(b.timestamp||0))
        .forEach(s=>renderOne(s,ctx));
}
function renderOne(s,ctx2) {
    if (!s) return;
    if      (s.type==='text')                              drawText(s,ctx2);
    else if (s.type==='lasso')                             drawLasso(s,ctx2);
    else if (s.type&&['line','circle','rectangle'].includes(s.type)) drawShape(s,ctx2);
    else if (s.points)                                     drawStroke(s.points,s.color,s.size,s.opacity,s.tool,ctx2);
}

// â”€â”€ Undo / Redo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.undo = function() {
    if (!undoStack.length) return;
    const last=undoStack.pop(); redoStack.push(last);
    const key=Object.keys(allStrokes).find(k=>allStrokes[k].userId===userId&&allStrokes[k].timestamp===last.timestamp);
    if (key) remove(ref(db,`boards/${currentBoard}/strokes/${key}`));
};
window.redo = function() {
    if (!redoStack.length) return;
    const s=redoStack.pop(); undoStack.push(s);
    push(strokesRef,s);
};

document.addEventListener('keydown', e => {
    if (['chatInput','textInputBox','loginEmail','loginPassword','regUsername','regEmail','regPassword'].includes(e.target?.id)) return;
    if ((e.ctrlKey||e.metaKey)&&e.key==='z') { e.preventDefault(); undo(); }
    if ((e.ctrlKey||e.metaKey)&&e.key==='y') { e.preventDefault(); redo(); }
    if (!e.ctrlKey&&!e.metaKey) {
        const map={b:'brush',e:'eraser',f:'fill',t:'text',l:'lasso'};
        if (map[e.key]) selectTool(map[e.key]);
    }
    konamiCheck(e.key);
});

// â”€â”€ Board switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initBoards() {
    const list=document.getElementById('boardsList');
    for (let i=1;i<=5;i++) {
        const d=document.createElement('div');
        d.className='board-item'+(i===1?' active':'');
        d.innerHTML=`<span>Board ${i}</span><span class="board-count" id="board${i}Count">0</span>`;
        d.onclick=()=>switchBoard(`board${i}`,d);
        list.appendChild(d);
    }
}
function switchBoard(id,el) {
    if (currentTool==='text'&&pendingTextPos) commitText();
    currentBoard=id;
    strokesRef=ref(db,`boards/${currentBoard}/strokes`);
    document.querySelectorAll('.board-item').forEach(b=>b.classList.remove('active'));
    el.classList.add('active');
    startBoardListeners();
    initCursors();
}

function startBoardListeners() {
    allStrokes={}; strokeCount=0; undoStack=[]; redoStack=[];
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);

    onValue(strokesRef, snap => {
        const data=snap.val()||{};
        allStrokes={}; strokeCount=0;
        Object.entries(data).forEach(([k,v])=>{ allStrokes[k]=v; strokeCount++; });
        document.getElementById('strokeCount').textContent=strokeCount;
        const bEl=document.getElementById(currentBoard+'Count');
        if (bEl) bEl.textContent=strokeCount;
        redrawCanvas();
    });
}

// â”€â”€ Live cursors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const liveCursorEls = {};

function initCursors() {
    Object.values(liveCursorEls).forEach(el=>el.remove());
    Object.keys(liveCursorEls).forEach(k=>delete liveCursorEls[k]);

    const cursRef = ref(db,`cursors/${currentBoard}`);
    onDisconnect(ref(db,`cursors/${currentBoard}/${userId}`)).remove();

    onValue(cursRef, snap => {
        const data=snap.val()||{};
        Object.keys(liveCursorEls).forEach(uid => {
            if (!data[uid]||uid===userId) { liveCursorEls[uid]?.remove(); delete liveCursorEls[uid]; }
        });
        Object.entries(data).forEach(([uid,info]) => {
            if (uid===userId) return;
            if (!liveCursorEls[uid]) {
                const el=document.createElement('div');
                el.className='live-cursor';
                el.innerHTML=`<svg width="16" height="20" viewBox="0 0 16 20"><path d="M0 0 L0 16 L4 12 L7 19 L9 18 L6 11 L11 11 Z" fill="${info.color}" stroke="#fff" stroke-width="1"/></svg><div class="live-cursor-label" style="background:${info.color}">${info.username}</div>`;
                document.getElementById('cursorOverlay').appendChild(el);
                liveCursorEls[uid]=el;
            }
            const cRect=canvas.getBoundingClientRect();
            const aRect=canvasArea.getBoundingClientRect();
            const sx=cRect.left-aRect.left + info.x*scale;
            const sy=cRect.top -aRect.top  + info.y*scale;
            liveCursorEls[uid].style.left=sx+'px';
            liveCursorEls[uid].style.top =sy+'px';
        });
    });
}

let _lastCursor=0;
canvas.addEventListener('mousemove', e => {
    const now=Date.now();
    if (now-_lastCursor<40) return;
    _lastCursor=now;
    const pos=getPos(e);
    set(ref(db,`cursors/${currentBoard}/${userId}`),{x:pos.x,y:pos.y,username,color:userColor,t:now});
});
canvas.addEventListener('mouseleave', ()=>remove(ref(db,`cursors/${currentBoard}/${userId}`)));

// â”€â”€ Report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleReport(x,y) {
    const s=findStrokeAt(x,y);
    if (!s) { alert('No stroke found here.'); return; }
    if (s.userId===userId) { alert('You cannot report your own strokes.'); return; }
    const reason=prompt('Reason for report:');
    if (!reason?.trim()) return;
    const rRef=push(ref(db,'reports'),{strokeId:s.id,reportedUser:s.userId,reporter:userId,reason:reason.trim(),timestamp:Date.now(),votes:{[userId]:true}});
    set(ref(db,'activeVote'),{reportId:rRef.key,reportedUser:s.userId,reason:reason.trim(),timestamp:Date.now()});
}
function findStrokeAt(x,y) {
    const tol=10;
    for (const [id,s] of Object.entries(allStrokes)) {
        if (s.points) { for (const p of s.points) { if (Math.hypot(p.x-x,p.y-y)<=tol+s.size/2) return {...s,id}; } }
        else if (s.start&&s.end) { if (ptLine(x,y,s.start.x,s.start.y,s.end.x,s.end.y)<=tol+s.size/2) return {...s,id}; }
    }
    return null;
}
function ptLine(px,py,x1,y1,x2,y2) {
    const dx=x2-x1,dy=y2-y1,len=Math.hypot(dx,dy);
    if(!len) return Math.hypot(px-x1,py-y1);
    const t=Math.max(0,Math.min(1,((px-x1)*dx+(py-y1)*dy)/(len*len)));
    return Math.hypot(px-(x1+t*dx),py-(y1+t*dy));
}

// â”€â”€ Vote system â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentVoteId=null;
function showVoteBanner(v,rid) {
    if (currentVoteId===rid) return;
    currentVoteId=rid;
    document.querySelector('.vote-banner')?.remove();
    const b=document.createElement('div');
    b.className='vote-banner';
    b.innerHTML=`<div class="vote-header">ðŸš¨ Vote to kick?</div><div class="vote-reason">Reason: ${v.reason}</div><div class="vote-actions"><button class="vote-btn vote-yes" onclick="castVote('${rid}',true)">Kick</button><button class="vote-btn vote-no" onclick="castVote('${rid}',false)">No</button></div><div class="vote-status" id="voteStatus">Waitingâ€¦</div>`;
    document.body.appendChild(b);
    setTimeout(()=>{b.remove();currentVoteId=null;},30000);
}
window.castVote = async function(rid,vote) {
    const snap=await get(ref(db,`reports/${rid}`));
    if(!snap.exists()) return;
    await update(ref(db,`reports/${rid}`),{votes:{...(snap.val().votes||{}),[userId]:vote}});
    document.getElementById('voteStatus').textContent='Voted!';
};
onValue(ref(db,'activeVote'),async snap=>{
    if(!snap.exists()) return;
    const v=snap.val();
    if(v.reportedUser===userId) return;
    showVoteBanner(v,v.reportId);
    const rs=await get(ref(db,`reports/${v.reportId}`));
    if(!rs.exists()) return;
    const yes=Object.values(rs.val().votes||{}).filter(x=>x===true).length;
    const us=await get(ref(db,'users'));
    if(yes>=Math.max(2,Math.ceil((us.exists()?Object.keys(us.val()).length:1)*0.4))){
        await set(ref(db,`bans/${v.reportedUser}`),{until:Date.now()+7200000,reason:v.reason,timestamp:Date.now()});
        await remove(ref(db,'activeVote'));
        const b=document.querySelector('.vote-banner');
        if(b){b.querySelector('#voteStatus').textContent='User kicked!';setTimeout(()=>b.remove(),3000);}
    }
});

// â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.toggleChat=function(){
    const c=document.getElementById('chatContainer');
    c.classList.toggle('minimized');
    document.getElementById('chatToggleBtn').textContent=c.classList.contains('minimized')?'+':'âˆ’';
};
window.sendMsg=function(){
    const inp=document.getElementById('chatInput'),msg=inp.value.trim();
    if(!msg) return;
    push(chatRef,{userId,username,color:userColor,message:censor(msg),timestamp:Date.now()});
    inp.value='';
};
onChildAdded(chatRef,snap=>{
    const d=snap.val(),box=document.getElementById('chatMessages');
    const el=document.createElement('div');
    el.className='chat-message';
    if(d.system){ el.classList.add('chat-system'); el.textContent=d.message; }
    else el.innerHTML=`<span class="chat-username" style="color:${d.color}">${d.username}:</span><span class="chat-text"> ${d.message}</span>`;
    box.appendChild(el); box.scrollTop=box.scrollHeight;
    while(box.children.length>100) box.removeChild(box.firstChild);
});

// â”€â”€ Presence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function trackPresence(){
    const uRef=ref(db,`users/${userId}`);
    set(uRef,{online:true,lastSeen:Date.now(),username,color:userColor});
    onDisconnect(uRef).remove();
    onValue(ref(db,'users'),snap=>{
        const n=snap.exists()?Object.keys(snap.val()).length:0;
        document.getElementById('onlineCount').textContent=n+' online';
    });
}

// â”€â”€ Canvas events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
canvas.addEventListener('mousedown',  startDrawing);
canvas.addEventListener('mousemove',  draw);
canvas.addEventListener('mouseup',    stopDrawing);
canvas.addEventListener('mouseleave', stopDrawing);
canvas.addEventListener('touchstart', e=>{e.preventDefault();startDrawing(e.touches[0]);});
canvas.addEventListener('touchmove',  e=>{e.preventDefault();draw(e.touches[0]);});
canvas.addEventListener('touchend',   e=>{e.preventDefault();stopDrawing(e.changedTouches[0]);});

// â”€â”€ Misc actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.clearCanvas=function(){
    if(!confirm('Clear canvas?')) return;
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    remove(strokesRef); allStrokes={}; strokeCount=0;
    document.getElementById('strokeCount').textContent=0;
};
window.downloadCanvas=function(){
    const a=document.createElement('a');
    a.download=`canvas-${currentBoard}-${Date.now()}.png`;
    a.href=canvas.toDataURL(); a.click();
};
document.getElementById('brushSize').addEventListener('input',e=>{brushSize=parseInt(e.target.value);document.getElementById('brushSizeValue').textContent=brushSize;});
document.getElementById('opacity').addEventListener('input',e=>{opacity=parseInt(e.target.value);document.getElementById('opacityValue').textContent=opacity;});

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hexToRgb(hex){
    const r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:{r:0,g:0,b:0};
}

// â”€â”€ Konami â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const KC=['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
let ki=0;
function konamiCheck(key){if(key===KC[ki]){ki++;if(ki===KC.length){showKonami();ki=0;}}else ki=0;}
function showKonami(){
    const ov=document.createElement('div');
    ov.className='konami-overlay';
    ov.innerHTML=`<div class="konami-title">DISCO MODE!</div><div class="konami-sub">You found the secret ðŸŽ‰ â€” ESC to close</div><button class="konami-close">Close</button>`;
    document.body.appendChild(ov);
    let h=0,iv=setInterval(()=>{document.body.style.background=`hsl(${h++%360},70%,10%)`;},50);
    const close=()=>{clearInterval(iv);document.body.style.background='#0a0a0a';ov.remove();document.removeEventListener('keydown',esc);};
    const esc=e=>{if(e.key==='Escape')close();};
    document.addEventListener('keydown',esc);
    ov.querySelector('.konami-close').onclick=close;
}

// â”€â”€ Ban check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkBan(){
    const s=await get(ref(db,`bans/${userId}`));
    if(!s.exists()) return false;
    const b=s.val();
    if(b.until>Date.now()){
        alert(`Banned for ${Math.ceil((b.until-Date.now())/60000)} more min.\nReason: ${b.reason}`);
        await signOut(auth);
        location.reload();
        return true;
    }
    return false;
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initApp(){
    if(await checkBan()) return;
    initColors();
    initBoards();
    trackPresence();
    startBoardListeners();
    initCursors();
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    applyTransform();
    push(chatRef,{system:true,message:`âœï¸ ${username} joined`,timestamp:Date.now()});
}
</script>
</body>
</html>
